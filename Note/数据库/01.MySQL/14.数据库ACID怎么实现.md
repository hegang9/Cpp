# 14.数据库ACID怎么实现

## 1.前言

我们在学MySQL的时候事务是必须要知道的部分，也就是原子性(Atomic)、一致性(Consistency)、隔离性(isolation)和持久性(Persistence)。知道他的概念其实是远远不够的，现在越来越卷，那么就必须知道的他的原理什么？怎么是实现的。

## 2.原理

### 2.1 原子性：

概念
是指事物是一个不可分割的工作单位，事物中的操作要么都发生，要么都不发生。最经典的就是转账案例，我们把转入和转出当做一个事物的话，就需要在SQL中显式指定开启事务。

### 2.2 实现原理：undo log

undo log 是 回滚日志也叫逻辑日志 是实现原子实现事务原子性和隔离性实现的基础。首先我们要清楚的是在实现原子性的是是由一个回滚的操作，回滚就是说我们在执行操作的时候那么我们会执行一个相反的操作来是数据库的状态变成之前为操作的状态。

具体的实现原理：在数据库执行操作的时候，InnoDB会生成一个undo log日志，里面包含的是数据库的SQL语句，如果说数据库的操作失败的时候，会调用rollback，导致事务回滚，那么InnoDB就可以利用undo log 进行一个回滚的操作，具体是如果说你之前执行的是insert操作那么就会执行一个相反的delete操作，之前执行的是delete操作那么就会执行一个insert操作，或者之前执行的是update操作那么就会执行一个反向的update操作。总得来说，就是InnoDB会根据回滚之前生成的undo log操作日志执行相反的操作。

## 3.一致性

### 3.1 概念

是说数据库事务不能破坏关系数据的完整性以及业务逻辑上的一致性。也就是说其他三个事务特性最终的目的的就是为了达到这个一致性效果。

## 4.隔离性

### 4.1 概念

指的是多个事务并发访问时，事务之间是隔离的，一个事务不应该影响其它事务运行效果。多个事务并发访问时，事务之间是隔离的，一个事务不应该影响其它事务运行效果。需要使用mvcc实现。如果不知道什么是MVCC的或者不知道其底层实现的可以去看我的前面几篇博客，写的很详细。https://blog.csdn.net/Ppphill_C/article/details/123833430?spm=1001.2014.3001.5501

## 5.持久性

### 5.1 概念

意味着即使出现了任何事故比如断电等，事务一旦提交，则持久化保存在数据库中，不会被回滚。

### 5.2 实现原理：redo log

redo log 是事务日志，用于保证事务的持久性。在这之前我们先要知道一下为什么需要用到他然后我们在去掌握我们要怎么用它，以及他的工作原理是什么？

我们都知道在数据库的操作过程中，一开始的话都是直接访问数据库的。所以效率并不是特别的好，并不能满足要求。因此就提出了一个buffer pool 这个概念，其中 buffer pool 是对数据库磁盘数据的一个映射，我们在操作的时候直接去读取buffer pool 就不必去读取数据库，那么buffer pool 会隔一段时间对数据库进行数据的更新操作，那么这一个过程又称 “刷脏”。

有了这个buffer pool 的加入可以大大的加快的数据库的访问速度，整体的提升了工作的效率。但是有一个不好的地方就是，如果说MySQL宕机了，buffer pool 开始刷脏，那么这个时候就会是数据的丢失。这就不符合我们的持久性问题了。因此，就提出了redo log这个日志来保证持久性。

首先我们要知道的是redo log 是采用的一种叫(Write-ahead logging)预先写的方法，换句话就是说所有的修改先写入日志，然后在更新到buffer pool。如果MySQL宕机，重启时可以读取redo log中的数据，对数据库进行恢复。这样就保证了数据不会因为MySQL宕机而丢失，从而满足持久性的要求。

我们可以根据下面这张图来加深一下理解：

![在这里插入图片描述](https://img-blog.csdnimg.cn/7c004a839fe242588b9b335135b26651.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA6IGq5piO5LiN5Zad54mb5aW2,size_20,color_FFFFFF,t_70,g_se,x_16)


这边大家应该会有这么一个疑问就是：既然redo log 也可以写入磁盘，那为什么他会比Buffer pool写入的时候更快呢？

- 刷脏是随机IO，因为每次修改的数据位置随机，但写redo log是追加操作，属于顺序IO。

- 刷脏是以数据页（Page）为单位的，MySQL默认页大小是16KB，一个Page上一个小修改都要整页写入；而redo log中只包含真正需要写入的部分，无效IO大大减少。这就有点redis中的AOF持久化的工作原理的味道了。


## 6.结语

好了，MySQL的事务就讲完了，希望能够给你带来帮助！收工~
