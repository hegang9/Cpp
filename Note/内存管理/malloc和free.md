## 从底层开讲malloc内存分配机制
#### 进程的内存布局
当一个程序被操作系统加载执行时，它会得到一个专属于它的、独立的虚拟地址空间。在这个空间中，内存被划分为几个主要区域，它们从低地址到高地址依次是：
1. 代码段：存储代码
2. 数据段：包含.data（存放已初始化的全局变量和静态变量）和.bss（存放未初始化或初始化为0的全局变量和静态变量）
3. 堆：用于动态内存分配的区域，从低地址向高地址增长
4. 内存映射段：进程与外界进行高效内存交互的关键通道，可映射共享库、实现进程通信、进行文件映射（将文件映射到该区域，对这段内存的读写操作会由操作系统自动回写到对应的文件位置，避免了对文件进行频繁的系统调用），从高地址向低地址增长。
5. 栈：用于函数调用，存放局部变量、参数等，从高地址向低地址增长
6. 内核空间：存放操作系统内核代码和数据

#### 堆的分配单元
malloc并不是以字节为单位管理堆内存的，而是以一个称为 chunk（内存块）​的结构为基本单位。每一个 chunk 都由两部分组成：**元数据（也称为 chunk 头）​ 和 可用内存（用户数据区）**
- 元数据：包含以下两个字段
  - mchunk_prev_size：存储前一个相邻 chunk​ 的大小（如果前一个 chunk 是空闲的）
  - mchunk_size：存储当前 chunk​ 的总大小。这个字段的低几位被用作标志位，其中最重要的是 P (PREV_INUSE)位，它指示了前一个 chunk 是正在使用中（1）还是空闲（0）
- 可用内存区：这是 malloc返回给用户的指针真正指向的区域。一个精妙的设计在于，当 chunk 被分配给用户后，其元数据中原本用于空闲链表指针的空间（fd, bk等）可以被用户数据覆盖复用，以节省空间。

#### Bins管理机制
为提高内存分配和回收效率，malloc维护并管理一个**内存池**（这个内存池在堆上），核心的管理结构就是bins（垃圾桶）。当分配和回收内存时，优先考虑这个内存池。bins的实质就是一组不同特性的空闲内存块链表：
| Bin类型      | 管理方式     | 块大小         | 特点与用途                                                                                                   |
| ------------ | ------------ | -------------- | ------------------------------------------------------------------------------------------------------------ |
| Fast bins    | 单链表       | 小             | 高速缓存，不立即合并相邻空闲块，分配/释放极快                                                                |
| Unsorted bin | 双向循环链表 | 各种大小       | 中转站，刚被释放的块先暂存在这，后续可快速复用                                                               |
| Small bins   | 双向循环链表 | 小（固定大小） | 每个 bin 管理相同大小的 chunk，速度很快。当 unsorted bin 中的 chunk 不合适时，会按大小归类到 small bins      |
| Large bins   | 双向循环链表 | 大（范围大小） | 每个 bin 管理一个大小范围内的 chunk，链表中的 chunk 按大小排序，分配时需要查找最佳匹配，速度较慢但管理大内存 |

#### malloc流程：
1. 将用户申请的大小加上元数据开销，得到真正需要分配的内存大小；
2. 查找bins，选择合适的内存块进行分配
   
#### malloc相关系统调用
1. brk()：将break指针直接设置为某个地址
2. sbrk()：将break指针从当前位置移动increment所指定的增量。
3. mmap()：当申请小内存的时，malloc使用sbrk分配内存；当申请大内存时，使用mmap函数在内存映射区申请内存；默认临界点是128KB。


#### free
1. 根据用户传入的 ptr，计算出其对应 chunk 的起始地址（ptr减去元数据大小）
2. 选择释放到哪个bins。